# ===========================================================
# üßº LIMPIEZA Y REEMPLAZO FINAL PARA POWER BI
# Autor: Antonio Carbo Le√≥n
# Descripci√≥n:
# Limpieza general, reemplazo "Otro" ‚Üí "Privada" en Instituci√≥n educativa
# y "Otro" ‚Üí "16" en Edad (versi√≥n verificada)
# ===========================================================

suppressMessages(library(dplyr))
suppressMessages(library(stringr))

# --- 1. Convertir todo a texto y limpiar saltos de l√≠nea / espacios ---
DatosLimpios <- dataset %>%
  mutate(across(everything(), as.character)) %>%
  mutate(across(everything(), ~ str_replace_all(., "[\\r\\n]", " ") %>% str_squish()))

# --- 2. Reemplazar vac√≠os o NA por "Sin especificar" ---
DatosLimpios <- DatosLimpios %>%
  mutate(across(everything(),
                ~ ifelse(is.na(.) | . == "" | str_trim(.) == "", "Sin especificar", .)))

# --- 3. Reemplazo en la columna Instituci√≥n educativa ("Otro" -> "Privada") ---
if ("Instituci√≥n educativa" %in% names(DatosLimpios)) {
  DatosLimpios$`Instituci√≥n educativa` <- ifelse(
    str_to_lower(str_trim(DatosLimpios$`Instituci√≥n educativa`)) == "otro",
    "Privada",
    DatosLimpios$`Instituci√≥n educativa`
  )
} else if ("Institucion educativa" %in% names(DatosLimpios)) {
  DatosLimpios$`Institucion educativa` <- ifelse(
    str_to_lower(str_trim(DatosLimpios$`Institucion educativa`)) == "otro",
    "Privada",
    DatosLimpios$`Institucion educativa`
  )
} else {
  print("‚ö†Ô∏è No se encontr√≥ la columna 'Instituci√≥n educativa'")
}

# --- 4. Reemplazo en la columna Edad ("Otro" -> "16") (versi√≥n corregida) ---
col_edad <- names(DatosLimpios)[
  str_detect(tolower(names(DatosLimpios)), "^edad\\b")
]

if (length(col_edad) == 0) {
  print("‚ö†Ô∏è No se encontr√≥ la columna 'Edad'")
} else {
  v <- DatosLimpios[[col_edad]]
  v <- str_replace_all(v, "[\\r\\n]", " ")      # eliminar saltos de l√≠nea
  v <- str_squish(v)                            # compactar espacios
  idx <- str_detect(v, regex("^otro$", ignore_case = TRUE))
  v[idx] <- "16"
  DatosLimpios[[col_edad]] <- v
  cat("‚úî Se reemplaz√≥ 'Otro' por '16' en", col_edad, "‚Üí", sum(idx, na.rm = TRUE), "coincidencias.\n")
}

# --- 5. Devolver dataset limpio ---
DatosLimpios
